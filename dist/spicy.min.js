const Element=function(e,t){this.name=e,this.instances=[],this.render=async(e,n)=>{const r=arrToAttrs(e),o=t?await t(r,n):null;return o instanceof Component?o:new Component({},o)},this.elements.push(this)};Element.prototype.add=function(e,t){const{name:n,instances:r}=this,o=`--spicyElement:${n}-${Date.now()}-${r.length}--`,s=strToAttrs(e),a=`\x3c!--${o}--\x3e`,l={id:o,attrs:s,content:t,holder:a};return l.render=async(e,t)=>{const n=await this.render(e,t),r=await n.mount,{nodes:o}=r;return o.length||await r.add(a),r},r.push(l),l},Element.prototype.elements=[],new Element("component",(({path:e},t)=>new Component({path:e},t).mount)),new Element("each",(({values:e},t)=>{const n=/\{ *(.+) *\}/g,r=e.map(((e,r)=>t.replace(n,`{ values[${r}].$1 }`))).join("\n");return new Component({values:e},r).mount})),new Element("if",(({value:e},t)=>e?t:""));const strToAttrs=e=>{const t=e.matchAll(/([^=]+)="([^"]*)"/g);return Array.from(t).map((e=>e.map((e=>e.trim())))).map((([e,t,n])=>({name:t,value:n})))},arrToAttrs=(e,t="result")=>e.reduce(((e,n)=>({...e,[n.name]:n[t]||n.value})),{}),Component=function(e,t,n){const{path:r}=e,o=new DocumentFragment;this.file=r?.split("/").pop()||"undefined",this.terms=[e],this.props={attrs:e},this.entry=n||new DocumentFragment,this.nodes=[],this.content=[],this.controlled=[],this.printed=!1,this.listener=()=>null,this.load=loadContent(r,t??"").then((e=>(t=e,this)));const s=this.load.then((()=>this.read(t))).then((({nodes:e,content:t,controlled:n})=>(this.nodes=e,this.content=t,this.controlled=n,this.nodes.map((({node:e})=>o.appendChild(e))),this.render()))).then((()=>this.printed=!0));this.mount=s.then((()=>(this.entry.appendChild(o),this))),this.props.onLoad=e=>this.load.then((()=>e())),this.props.onMount=e=>this.mount.then((()=>e())),this.props.onChange=e=>this.listener=t=>e(this,t),this.props.addTerms=(...e)=>{e.map((e=>this.terms.push(e)))},this.props.addState=e=>{const[t,n]=addState(e);return n(this.render.bind(this)),t}};Component.prototype.read=function(e){const t=cleanContent(e),{props:n,file:r}=this,[o,s]=replaceCustomElements(t),a=makeTree(o),l=pickLeafts(a,"style"),i=pickLeafts(a,"script"),c=pickContent(a)||[],d=flat(c,(e=>e.content));return Promise.all([...readStyles(r,l),...readScripts(r,i,n),...readCustoms(a,d,s)]).then((()=>{const e=pickControlled(d);return{nodes:c,content:d,controlled:e}}))},Component.prototype.update=function(e){const t=(e,n,r=0)=>{const o=Math.max(e.length||0,n.length||0),s=e[0]?.node.parentNode;for(let a=0;a<o;a++){const o=e[a],l=n[a];if(o&&!l&&s?.removeChild(o.node),!o&&l&&s?.appendChild(l.node),o&&l){const e=l.node.nodeName!==o.node.nodeName,n=Array.isArray(l.content),s=Array.isArray(o.content);e||n!==s?o.node.replaceWith(l.node):(n||s||(l.content.result=o.content.result),l.node=o.node),n&&s&&t(o.content,l.content,r+1)}}};return t(this.nodes,e.nodes),this.terms=e.terms,this.props=e.props,this.nodes=e.nodes,this.content=e.content,this.controlled=pickControlled(this.content),this.render()},Component.prototype.render=function(){const e=this.terms.reduce(((e,t)=>({...e,...t}))),t=this.controlled.map((t=>{const{linked:n,node:r,custom:o}=t;return(n.map((t=>{const{value:n}=t,o=valueEval(n,e);return renderItem(r,t,o,e)})).filter(Boolean).length||!this.printed)&&o&&renderCustom(t)}));return Promise.all(t).then((()=>this.printed&&this.listener(e))).then((()=>reqFramePromise()))},Component.prototype.add=async function(e){const{nodes:t,content:n,controlled:r}=await this.read(e);this.nodes=[...this.nodes,...t],this.content=[...this.content,...n],this.controlled=[...this.controlled,...r],t.map((({node:e})=>this.entry.appendChild(e)))};const loadContent=async(e,t)=>{const n=e?await fetch(e):null;return[t,200===n?.status?await n.text():null].filter(Boolean).join("\n")},cleanContent=e=>"string"==typeof e?e.replace(/>[ \n\t\t]*/g,">").trim():e,replaceCustomElements=e=>{const{elements:t}=Element.prototype,n=[];return t.map((t=>{const{name:r}=t;[new RegExp(`<${r}(.*?)>(.*)</${r}>`),new RegExp(`<${r}(.*?)/?>`)].map(((r,o)=>{for(;r.test(e);)e=e.replace(r,((e,r,s)=>{const a=o?null:s,l=t.add(r,a);return n.push(l),l.holder}))}))})),[e,n]},makeTree=e=>{const t=document.createElement("div");return"string"==typeof e&&(t.innerHTML=e),e instanceof DocumentFragment&&t.appendChild(e),t},pickLeafts=(e,t)=>{const n=new DocumentFragment;return Array.from(e.querySelectorAll(t)).map((e=>(n.appendChild(e),e)))},pickContent=(()=>{const e=t=>{const n=t.childNodes;return n.length?Array.from(n).map((t=>{const n=e(t);return{attrs:Array.from(t.attributes||[]).map((({name:e,value:t})=>({name:e,value:t}))),content:n,node:t,custom:null}})):{value:t.textContent}};return t=>{const n=e(t);return Array.isArray(n)?n:null}})(),pickControlled=e=>{const t=e=>/\{[^\}]+\}/.test(e.value);return e.map((e=>{const{attrs:n,content:r}=e,o=[...n,r].filter(t);return{...e,linked:o}})).filter((({linked:e,custom:t})=>e.length||t))},readStyles=(e,t)=>t.map(((t,n)=>{const r=(n+"").padStart(3,"0"),o=document.createElement("link"),s=t.textContent.replace(/@import url\(['"]?(.+)/g,((e,t)=>e.replace(t,window.location.href+t))),a=blobUrl(`${s}\n/*# sourceURL=style-${r}_${e}.css*/`,{type:"text/css"});return o.rel="stylesheet",o.type="text/css",o.href=a.use(),document.head.appendChild(o),new Promise(((e,t)=>{o.onload=e,o.onerror=t}))})),readScripts=(e,t,n)=>t.map(((t,r)=>{const o=(r+"").padStart(3,"0"),s=formatScript(t.textContent,n),a=blobUrl(s+`\n//# sourceURL=script-${o}_${e}.js`,{type:"text/javascript"});return import(a.use()).then((e=>(a.delete(),e.default(n),e.default)))})),readCustoms=(e,t,n)=>n.map((n=>{const{id:r,attrs:o,content:s}=n,a=findComments(e,r)[0],l=t.find((({node:e})=>e===a));return l&&(l.attrs=o,l.content.value=s,l.custom=n),l})),formatScript=(e,t)=>{const n=`{ ${Object.keys(t).join(", ")} }`,r=e.replace(/\/\/[\w\W]*?\n/g,"").replace(/\/\*[\w\W]*?\*\//g,"").matchAll(/(?:const|let|var) ([^=]+)/g),o=Array.from(r).map((([e,t])=>t.trim().replace(/^[\{\[]|[\}\]]$/g,""))).join(", ");let s="";return e=(e=e.replace(/import.+from(.+);?\n?/g,((e,t)=>{const n=t.replace("./",window.location.href);return s=e.replace(t,n)}))).replace(s,`${s}\nexport default (${n}) => {\n`),e+=`\n  addTerms({ ${o} });`,e+="\n};"},renderItem=(e,t,n,r)=>{const{name:o,result:s}=t,a=n===s,l=8===e.nodeType,i="function"==typeof n;if(a)return!1;if(!l)if(o){/^on/.test(o)?renderListener(e,o,n,s):i?e.setAttribute(o,n(r)):e.setAttribute(o,n)}else e.textContent=i?n(r):n;return t.result=n,!0},renderListener=(e,t,n,r)=>{const o="function"==typeof n,s=!r||r.toString()!==n.toString(),a=t.replace(/^on/,""),l=o?n:window[n];l&&s&&(e.removeAttribute(t),/change/i.test(a)?e.addEventListener("input",l):e.addEventListener(a,l))},renderCustom=async e=>{const{attrs:t,content:n,custom:r}=e,o=await r.render(t,n.value);if(r.rendered)return r.rendered.update(o);const s=r.rendered?.nodes||[e],a=s.shift().node,l=a.parentNode;return s.map((({node:e})=>l.removeChild(e))),l.replaceChild(o.entry,a),o.entry=l,r.rendered=o,o.mount},addState=e=>{let t=[];const n={};return Object.entries(e).map((([e,r])=>{((e,t,n,r)=>{Object.defineProperty(e,t,{enumerable:!0,get:()=>n,set:e=>{e!==n&&deffer(r),n=e}})})(n,e,r,(()=>{t.map((e=>e(n)))}))})),[n,e=>("function"==typeof e&&t.push(e),()=>{t=t.filter((t=>t!==e))})]},valueEval=(e,t)=>{const n=/\{([\w\W]*?)\}/g,r=e.trim().match(n);if(1===r.length&&r[0]===e){const r=e.replace(n,"$1");return doEval(r,t)}return e.replace(n,((e,n,r)=>doEval(n,t)))},doEval=(()=>{const global={};return(e,t)=>{const n=Object.keys(t),r=n.map((e=>t[e])),o=n.join(",");return doEval("__fun"+Date.now(),`function(${o}){\n      try { return ${e} }\n      catch (err) { return undefined }\n    };\n    //# sourceURL=spicy.js`,r)};function doEval(){eval("global."+arguments[0]+"="+arguments[1]);const result=global[arguments[0]].apply({},arguments[2]);return delete global[arguments[0]],result}})(),reqFramePromise=()=>new Promise((e=>{requestAnimationFrame(e)})),blobUrl=(e,t)=>{const n=new Blob([e],t);return{use:()=>URL.createObjectURL(n),delete:()=>URL.revokeObjectURL(n)}},flat=(e,t,n)=>(n=n||[],e.map((function(e){const r=t?t(e):e;Array.isArray(r)&&flat(r,t,n),n.push(e)})),n),findComments=(e,t)=>{const n=new RegExp(t),r=[],o=document.createNodeIterator(e,NodeFilter.SHOW_COMMENT,(function(){return NodeFilter.FILTER_ACCEPT}),!1);let s;for(;s=o.nextNode();)n.test(s.nodeValue)&&r.push(s);return r},deffer=(()=>{let e;return t=>{e&&clearTimeout(e),e=setTimeout(t,0)}})();export{Component,Element,addState};
